<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!--==================== UNICONS ====================-->
        <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.8/css/line.css">
        
        
        <!--==================== CSS ====================-->
        <link rel="stylesheet" href="styles.css">

        <title>Martial Portfolio</title>
    </head>
    <body>
       <!--==================== HEADER ====================-->
       <header class="header" id="header">
        <nav class="nav container">
            <a href="#" class="nav__logo">Martial</a>
            <div class="nav__menu" id="nav-menu">
                <ul class="nav__list grid">
                    <li class="nav__item">
                        <a href="index.html" class="nav__link active-link">
                         Home
                        </a>
                    </li>

                    <li class="nav__item">
                        <a href="about.html" class="nav__link">
                            About
                            
                        </a>
                    </li>

                    <li class="nav__item">
                        <a href="Blogs.html" class="nav__link">
                             Blogs
                            
                        </a>
                    </li>

                    <li class="nav__item">
                        <a href="portfolio.html" class="nav__link">
                             my work
                        </a>
                    </li>

                    <li class="nav__item">
                        <a href="contact.html" class="nav__link">
                           Contactme
                        </a>
                    </li>

                    <li class="nav__item nav__login dropdown">
                        <a href="login.html" class="nav__link">Sign in</a>
                        
                    </li>

                    <li class="nav__item dropdown admin">
                       
                    </li>

                   
                </ul>
                <div class="hamburger">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
                
            </div>
        </nav>
    </header>


        <!--==================== MAIN ====================-->
        <main class="main">
          <section class="section" id="services">

            <div class="Article__container container grid"> 

                <div id="editModal" class="modal">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal()">&times;</span>
                        <h2>Edit Article</h2>
                        <form id="editForm">
                            <input type="hidden" id="editId">
                            <input class="add__admin" type="file" id="editPhoto" name="editPhoto" accept="image/*">
                            <input class="add__admin" type="text" id="editTitle" placeholder="Title">
                            <textarea class="add__admin" id="editDesc" cols="30" rows="10" placeholder="Description"></textarea>
                            <button type="submit" class="add__button">Edit article</button>
                        </form>
                    </div>
                </div>

                  <a href="adminaddarticle.html" class="article__add">
                    <button>Add an article</button>
                  </a>

                  <div id="article__grid"></div>
            </div>
        </section>
        </main>

        <!--==================== FOOTER ====================-->
        <footer class="footer">
         <div class="footer__bg">
            <div class="footer__container container grid">
                <div>
                    <h1 class="footer__title">Martial</h1>
                    <span class="footer__subtitle">Backend developer</span>
                </div>

                <ul class="footer__links">
                    <li>
                        <a href="#services" class="footer__link">Services</a>
                    </li>

                    <li>
                        <a href="#portfolio" class="footer__link">Portfolio</a>
                    </li>

                    <li>
                        <a href="#contact" class="footer__link">Contactme</a>
                    </li>
                </ul>


                <div class="footer__socials">
                    <a href="" class="footer__social" target="_blank">
                        <i class="uil uil-facebook-f"></i>
                    </a>

                    <a href="" class="footer__social" target="_blank">
                        <i class="uil uil-instagram"></i>
                    </a>

                    <a href="" class="footer__social" target="_blank">
                        <i class="uil uil-twitter-alt"></i>
                    </a>
                </div>
            </div>
            <p class="footer__copy">&#169; Martial. All right reserved</p>
         </div>
        </footer>       
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const hamburger = document.querySelector(".hamburger");
                const navMenu = document.querySelector(".nav__list")
                const loginDiv = document.querySelector('.nav__login');
                const Admin = document.querySelector('.admin');
                const displayDiv = document.getElementById('article__grid')
    
                hamburger.addEventListener("click", () => {
                    hamburger.classList.toggle("active");
                    navMenu.classList.toggle("active");
                });

    
    const updateUserUI = () => {
    const currentUser = JSON.parse(localStorage.getItem('loginUser'));

    if (currentUser && currentUser.username) {
        if (currentUser.isAdmin === true) {
            Admin.innerHTML = `
                <a href="#" class="nav__link">
                    Admin <i class="fas fa-chevron-down"></i>
                </a>
                <ul class="dropdown-content">
                    <li><a href="adminquery.html">Query</a></li>
                    <li><a href="adminarticle.html">Article</a></li>
                </ul>
            `;
        } else {
            Admin.innerHTML = '';
        }
        loginDiv.innerHTML = `
            <a href="#" class="nav__link">
                ${currentUser.username}
            </a>
            <ul class="dropdown-content">
                    <li ><a id="logout" href="#">Logout</a></li>
                </ul>
        `;
    } else {
        loginDiv.innerHTML = `
            <a href="login.html" class="nav__link">
                Sign in
            </a>
        `;
        Admin.innerHTML = ''; 
    }
};

updateUserUI()
 document.addEventListener('click', (e) => {
        
        if(e.target.id === 'logout'){
            e.preventDefault()
            localStorage.removeItem('loginUser');
            window.location.href = "register.html"
            updateUserUI();
        }
    })
    
    const displayArticle = (articles) => {
        displayDiv.innerHTML = '';

        articles.forEach(article => {
            displayDiv.innerHTML += `
                <div class="article grid">
                    <div class="article__img">
                        <img src="${article.photo}"  alt="">
                    </div>
                    <p>${article.description}</p>
                    <div>
                        <a href="#" onclick="openEditModal(${article.id}, '${article.title}', '${article.description}')">
                        <img class="article__icon" src="assets/img/Rectangle 57.png" alt="">
                        </a>

                        <a href="#" onclick="deleteArticle(${article.id})">
                            <img class="article__icon" src="assets/img/Rectangle 58.png" alt="">
                        </a>
                    </div>
                </div>
            `;
        });
    };

    window.deleteArticle = (id) => {
        let articles = JSON.parse(localStorage.getItem('article'));
        articles = articles.filter(article => article.id !== id); 
        localStorage.setItem('article', JSON.stringify(articles));
        console.log('Article deleted');
        displayArticle(articles);
    };

    window.openEditModal = (id, title, description) => {
        const editIdInput = document.getElementById('editId');
        const editTitleInput = document.getElementById('editTitle');
        const editDescInput = document.getElementById('editDesc');

        editIdInput.value = id;
        editTitleInput.value = title;
        editDescInput.value = description;

        const editModal = document.getElementById('editModal');
        editModal.style.display = 'block';
    };         
    
    const handleEditFormSubmit = (e, articleId) => {
        e.preventDefault();

        const updatedTitle = document.getElementById('editTitle').value;
        const updatedDesc = document.getElementById('editDesc').value;
        const updatedPhoto = document.getElementById('editPhoto').files[0];

        let articles = JSON.parse(localStorage.getItem('article'));

        const index = articles.findIndex(article => article.id === parseInt(articleId));

        articles[index].title = updatedTitle;
        articles[index].description = updatedDesc;

        if (updatedPhoto) {

            const reader = new FileReader();
            reader.onload = function(event) {
                const photoDataUrl = event.target.result;
                articles[index].photo = photoDataUrl;

                localStorage.setItem('article', JSON.stringify(articles));

                closeModal();

                displayArticle(articles);
            };
            reader.readAsDataURL(updatedPhoto);
        } else {
            localStorage.setItem('article', JSON.stringify(articles));

            closeModal();
            displayArticle(articles);
        }
    };

    window.closeModal = () => {
        const editModal = document.getElementById('editModal');
        editModal.style.display = 'none';
    };

    document.getElementById('editForm').addEventListener('submit', (e) => {
        const articleId = document.getElementById('editId').value;
        handleEditFormSubmit(e, articleId);
    });

    const articles = JSON.parse(localStorage.getItem('article'));
    displayArticle(articles);

    const user = JSON.parse(localStorage.getItem('loginUser'));
      if (!user || (!user.isLoggedIn || !user.isAdmin)) {
       window.location.href = "index.html";
       }
            });
        </script>
    </body>
</html>